/*
 * Copyright 2023 Apollo Authors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
package com.ctrip.framework.apollo.build.sql.converter;

import freemarker.template.Configuration;
import freemarker.template.Template;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.StringWriter;
import java.io.UncheckedIOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.nio.file.DirectoryStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.security.CodeSource;
import java.security.ProtectionDomain;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Set;
import java.util.StringJoiner;

public class ApolloSqlConverterUtil {


  public static String getRepositoryDir() {
    ProtectionDomain protectionDomain = ApolloSqlConverter.class.getProtectionDomain();
    CodeSource codeSource = protectionDomain.getCodeSource();
    URL location = codeSource.getLocation();
    URI uri;
    try {
      uri = location.toURI();
    } catch (URISyntaxException e) {
      throw new IllegalArgumentException(e.getLocalizedMessage(),e);
    }
    Path path = Paths.get(uri);
    String unixClassPath = path.toString().replace("\\", "/");

    if (!unixClassPath.endsWith("/apollo-build-sql-converter/target/classes")) {
      throw new IllegalStateException("illegal class path: " + unixClassPath);
    }

    return ApolloSqlConverterUtil.replacePath(unixClassPath,
        "/apollo-build-sql-converter/target/classes", "");
  }

  public static void ensureDirectories(String targetFilePath) {
    Path path = Paths.get(targetFilePath);
    Path dirPath = path.getParent();
    try {
      Files.createDirectories(dirPath);
    } catch (IOException e) {
      throw new UncheckedIOException(e);
    }
  }

  public static String process(SqlTemplate sqlTemplate, SqlTemplateContext context) {
    Template freemarkerTemplate = sqlTemplate.getTemplate();
    StringWriter writer = new StringWriter();
    try {
      freemarkerTemplate.process(context, writer);
    } catch (Exception e) {
      throw new RuntimeException(e);
    }
    return writer.toString();
  }

  public static String replacePrefix(String origin, String prefix, String target) {
    if (!origin.startsWith(prefix)) {
      throw new IllegalArgumentException("illegal file path: " + origin);
    }
    return origin.replace(prefix, target);
  }

  public static String replacePath(String origin, String src, String target) {
    if (!origin.contains(src)) {
      throw new IllegalArgumentException("illegal file path: " + origin);
    }
    return origin.replace(src, target);
  }

  public static SqlTemplateGist getGists(String repositoryDir) {
    String gistDir = repositoryDir + "/scripts/sql-gist";
    String autoGeneratedDeclaration = getGist(gistDir + "/autoGeneratedDeclaration.sql");
    String h2Function = getGist(gistDir + "/h2Function.sql");
    String setupDatabase = getGist(gistDir + "/setupDatabase.sql");
    String useDatabase = getGist(gistDir + "/useDatabase.sql");
    return SqlTemplateGist.builder()
        .autoGeneratedDeclaration(autoGeneratedDeclaration)
        .h2Function(h2Function)
        .setupDatabase(setupDatabase)
        .useDatabase(useDatabase)
        .build();
  }

  private static String getGist(String gistPath) {
    StringJoiner joiner = new StringJoiner("\n", "\n", "");
    boolean accept = false;
    try (BufferedReader bufferedReader = Files.newBufferedReader(Paths.get(gistPath),
        StandardCharsets.UTF_8)) {
      for (String line = bufferedReader.readLine(); line != null;
          line = bufferedReader.readLine()) {
        if (line.contains("@@gist-start@@")) {
          accept = true;
          continue;
        }
        if (line.contains("@@gist-end@@")) {
          break;
        }
        if (accept) {
          joiner.add(line);
        }
      }
    } catch (IOException e) {
      throw new UncheckedIOException("failed to open gistPath " + e.getLocalizedMessage(), e);
    }
    return joiner.toString();
  }

  public static List<String> getSqlList(String dir, Set<String> ignoreDirs) {
    List<String> sqlList = new ArrayList<>();
    if (Files.exists(Paths.get(dir + "/apolloconfigdb.sql"))) {
      sqlList.add(dir + "/apolloconfigdb.sql");
    }
    if (Files.exists(Paths.get(dir + "/apolloportaldb.sql"))) {
      sqlList.add(dir + "/apolloportaldb.sql");
    }
    List<String> deltaSqlList = getDeltaSqlList(dir, ignoreDirs);
    sqlList.addAll(deltaSqlList);
    return sqlList;
  }

  public static List<String> getSqlList(String dir) {
    return getSqlList(dir, Collections.emptySet());
  }

  public static List<Path> list(Path dir) {
    List<Path> subPathList = new ArrayList<>();
    try (DirectoryStream<Path> ds = Files.newDirectoryStream(dir)) {
      for (Path path : ds) {
        subPathList.add(path);
      }
    } catch (IOException e) {
      throw new UncheckedIOException("failed to open dir " + e.getLocalizedMessage(), e);
    }
    return subPathList;
  }

  private static List<String> getDeltaSqlList(String dir, Set<String> ignoreDirs) {
    Path dirPath = Paths.get(dir + "/delta");
    if (!Files.exists(dirPath)) {
      return Collections.emptyList();
    }
    List<Path> deltaDirList = list(dirPath);
    List<String> deltaSqlList = new ArrayList<>();
    for (Path deltaDir : deltaDirList) {
      if (!Files.isDirectory(deltaDir)) {
        continue;
      }
      if (ignoreDirs.contains(deltaDir.toString().replace("\\", "/"))) {
        continue;
      }
      List<Path> deltaFiles = list(deltaDir);
      for (Path path : deltaFiles) {
        String fileName = path.toString();
        if (fileName.endsWith(".sql")) {
          deltaSqlList.add(fileName.replace("\\", "/"));
        }
      }
    }

    return deltaSqlList;
  }


  public static List<SqlTemplate> toTemplates(List<String> srcSqlList, String srcDir,
      Configuration configuration) {
    List<SqlTemplate> templateList = new ArrayList<>(srcSqlList.size());
    for (String srcSql : srcSqlList) {
      String templateName = ApolloSqlConverterUtil.replacePrefix(srcSql, srcDir + "/", "");
      Template template;
      try {
        template = configuration.getTemplate(templateName);
      } catch (IOException e) {
        throw new UncheckedIOException(e);
      }
      templateList.add(new SqlTemplate(srcSql, template));
    }
    return templateList;
  }
}
